<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="description" content="Frequency Studio - Piano color√©, Brainwaves, Spooky2/Rife avec effets Echo, Reverb, Loop">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>üéπ Frequency Studio - Piano ‚Ä¢ Brainwaves ‚Ä¢ Effets</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="assets/icon.svg">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    
    <style>
        :root {
            --bg-deep: #0a0a0f;
            --bg-card: #12121a;
            --bg-hover: #1a1a25;
            --accent: #00d4aa;
            --accent-alt: #7c6aef;
            --text: #e0e0e0;
            --text-dim: #666;
            
            /* Note colors */
            --note-do: #e74c3c;
            --note-re: #e67e22;
            --note-mi: #f1c40f;
            --note-fa: #2ecc71;
            --note-sol: #3498db;
            --note-la: #9b59b6;
            --note-si: #e91e63;
            
            /* Brainwave colors */
            --delta: #1a237e;
            --theta: #4a148c;
            --alpha: #00695c;
            --beta: #e65100;
            --gamma: #b71c1c;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-deep);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo h1 {
            font-size: 1.2rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-alt));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .tabs {
            display: flex;
            gap: 4px;
            overflow-x: auto;
        }
        
        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .tab:hover { background: var(--bg-hover); color: var(--text); }
        .tab.active { background: var(--accent); color: #000; font-weight: 600; }
        
        /* Main */
        .main { padding: 16px; }
        .panel { display: none; }
        .panel.active { display: block; }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 1rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Piano color√© */
        .piano-colored {
            display: flex;
            gap: 4px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .piano-key-colored {
            width: 50px;
            height: 120px;
            border-radius: 0 0 8px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 10px;
            cursor: pointer;
            transition: all 0.1s;
            color: #fff;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .piano-key-colored:hover { transform: translateY(-4px); }
        .piano-key-colored:active, .piano-key-colored.playing {
            transform: translateY(2px);
            filter: brightness(1.2);
        }
        
        .piano-key-colored.do { background: linear-gradient(180deg, #c0392b, var(--note-do)); }
        .piano-key-colored.re { background: linear-gradient(180deg, #d35400, var(--note-re)); }
        .piano-key-colored.mi { background: linear-gradient(180deg, #f39c12, var(--note-mi)); }
        .piano-key-colored.fa { background: linear-gradient(180deg, #27ae60, var(--note-fa)); }
        .piano-key-colored.sol { background: linear-gradient(180deg, #2980b9, var(--note-sol)); }
        .piano-key-colored.la { background: linear-gradient(180deg, #8e44ad, var(--note-la)); }
        .piano-key-colored.si { background: linear-gradient(180deg, #c2185b, var(--note-si)); }
        
        .key-note { font-size: 1.2rem; }
        .key-freq { font-size: 0.65rem; opacity: 0.8; margin-top: 4px; }
        
        /* Octave selector */
        .octave-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .octave-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
        }
        
        .octave-btn.active { background: var(--accent); color: #000; }
        
        /* Sequencer */
        .sequencer-grid {
            display: grid;
            gap: 4px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .seq-row {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .seq-label {
            width: 40px;
            font-size: 0.75rem;
            text-align: right;
            padding-right: 8px;
            color: var(--text-dim);
        }
        
        .seq-cell {
            width: 32px;
            height: 28px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .seq-cell:hover { background: rgba(255,255,255,0.15); }
        .seq-cell.active { transform: scale(0.95); }
        .seq-cell.playing { box-shadow: 0 0 8px var(--accent); }
        
        /* Note row colors */
        [data-note="C"] .seq-cell.active { background: var(--note-do); }
        [data-note="D"] .seq-cell.active { background: var(--note-re); }
        [data-note="E"] .seq-cell.active { background: var(--note-mi); }
        [data-note="F"] .seq-cell.active { background: var(--note-fa); }
        [data-note="G"] .seq-cell.active { background: var(--note-sol); }
        [data-note="A"] .seq-cell.active { background: var(--note-la); }
        [data-note="B"] .seq-cell.active { background: var(--note-si); }
        
        /* Brainwaves */
        .wave-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }
        
        .wave-card {
            padding: 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            text-align: center;
        }
        
        .wave-card:hover { transform: translateY(-2px); }
        .wave-card.active { border-color: var(--accent); }
        
        .wave-card.delta { border-left: 4px solid var(--delta); }
        .wave-card.theta { border-left: 4px solid var(--theta); }
        .wave-card.alpha { border-left: 4px solid var(--alpha); }
        .wave-card.beta { border-left: 4px solid var(--beta); }
        .wave-card.gamma { border-left: 4px solid var(--gamma); }
        
        .wave-symbol { font-size: 2rem; margin-bottom: 8px; }
        .wave-name { font-weight: 600; }
        .wave-freq { font-size: 0.8rem; color: var(--accent); margin-top: 4px; }
        
        /* Effects */
        .effect-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .effect-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .effect-icon { font-size: 1.5rem; }
        
        .toggle {
            width: 50px;
            height: 28px;
            background: rgba(255,255,255,0.1);
            border-radius: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.2s;
        }
        
        .toggle.active { background: var(--accent); }
        .toggle.active::after { left: 25px; }
        
        /* Sliders */
        .control-group { margin: 16px 0; }
        .control-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 8px;
        }
        
        .slider-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .value { min-width: 60px; text-align: right; color: var(--accent); font-family: monospace; }
        
        /* Visualizer */
        .visualizer {
            width: 100%;
            height: 100px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            margin: 16px 0;
        }
        
        .visualizer canvas { width: 100%; height: 100%; border-radius: 12px; }
        
        /* Transport */
        .transport {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 16px;
            margin-top: 16px;
            position: sticky;
            bottom: 16px;
        }
        
        .transport-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: var(--text);
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .transport-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .transport-btn.play { background: var(--accent); color: #000; }
        .transport-btn.playing { background: #e74c3c; }
        
        .tempo-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tempo-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: var(--text);
            cursor: pointer;
        }
        
        .tempo-display {
            font-family: monospace;
            font-size: 1.2rem;
            min-width: 80px;
            text-align: center;
        }
        
        .time-display {
            font-family: monospace;
            font-size: 1.1rem;
            color: var(--accent);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary { background: var(--accent); color: #000; }
        .btn-secondary { background: var(--accent-alt); color: #fff; }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
        
        /* Export buttons */
        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        
        /* Duration buttons */
        .duration-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 16px 0;
        }
        
        .duration-btn {
            padding: 10px 16px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .duration-btn.active { background: var(--accent); color: #000; }
        
        /* Responsive */
        @media (max-width: 600px) {
            .header { flex-direction: column; gap: 12px; }
            .tabs { width: 100%; justify-content: center; }
            .piano-key-colored { width: 42px; height: 100px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <span style="font-size:1.6rem">üéπ</span>
            <h1>Frequency Studio</h1>
        </div>
        <div class="tabs">
            <button class="tab active" data-panel="piano">üéπ Piano</button>
            <button class="tab" data-panel="sequencer">üéº S√©quenceur</button>
            <button class="tab" data-panel="brainwaves">üß† Brainwaves</button>
            <button class="tab" data-panel="effects">üéõÔ∏è Effets</button>
        </div>
    </header>
    
    <main class="main">
        <!-- PIANO PANEL -->
        <div class="panel active" id="panelPiano">
            <div class="card">
                <h3 class="card-title">üéµ Do R√© Mi Fa Sol La Si</h3>
                
                <div class="octave-selector">
                    <button class="octave-btn" data-octave="2">Oct 2</button>
                    <button class="octave-btn" data-octave="3">Oct 3</button>
                    <button class="octave-btn active" data-octave="4">Oct 4</button>
                    <button class="octave-btn" data-octave="5">Oct 5</button>
                </div>
                
                <div class="piano-colored" id="pianoColored">
                    <div class="piano-key-colored do" data-note="C" data-freq="261.63">
                        <span class="key-note">Do</span>
                        <span class="key-freq">261.63</span>
                    </div>
                    <div class="piano-key-colored re" data-note="D" data-freq="293.66">
                        <span class="key-note">R√©</span>
                        <span class="key-freq">293.66</span>
                    </div>
                    <div class="piano-key-colored mi" data-note="E" data-freq="329.63">
                        <span class="key-note">Mi</span>
                        <span class="key-freq">329.63</span>
                    </div>
                    <div class="piano-key-colored fa" data-note="F" data-freq="349.23">
                        <span class="key-note">Fa</span>
                        <span class="key-freq">349.23</span>
                    </div>
                    <div class="piano-key-colored sol" data-note="G" data-freq="392.00">
                        <span class="key-note">Sol</span>
                        <span class="key-freq">392.00</span>
                    </div>
                    <div class="piano-key-colored la" data-note="A" data-freq="440.00">
                        <span class="key-note">La</span>
                        <span class="key-freq">440.00</span>
                    </div>
                    <div class="piano-key-colored si" data-note="B" data-freq="493.88">
                        <span class="key-note">Si</span>
                        <span class="key-freq">493.88</span>
                    </div>
                </div>
                
                <div class="visualizer">
                    <canvas id="pianoVisualizer"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">‚ô© Dur√©es des notes</h3>
                <div class="duration-btns">
                    <button class="duration-btn" data-dur="0.125" title="Double croche">ùÖòùÖ•ùÖØ</button>
                    <button class="duration-btn" data-dur="0.25" title="Croche">‚ô™</button>
                    <button class="duration-btn active" data-dur="0.5" title="Noire">‚ô©</button>
                    <button class="duration-btn" data-dur="1" title="Blanche">ùÖóùÖ•</button>
                    <button class="duration-btn" data-dur="2" title="Ronde">ùÖù</button>
                </div>
                <p style="font-size:0.8rem;color:var(--text-dim)">‚ô© Noire + ‚ô© Noire = ùÖóùÖ• Blanche</p>
            </div>
        </div>
        
        <!-- SEQUENCER PANEL -->
        <div class="panel" id="panelSequencer">
            <div class="card">
                <h3 class="card-title">üéº S√©quenceur 16 pas</h3>
                <div class="sequencer-grid" id="sequencerGrid"></div>
            </div>
            
            <div class="card">
                <div class="control-group">
                    <label>Steps</label>
                    <div class="slider-row">
                        <input type="range" id="seqSteps" min="8" max="32" value="16">
                        <span class="value" id="seqStepsVal">16</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- BRAINWAVES PANEL -->
        <div class="panel" id="panelBrainwaves">
            <div class="card">
                <h3 class="card-title">üß† Ondes C√©r√©brales</h3>
                <div class="wave-cards">
                    <div class="wave-card delta" data-wave="delta" data-freq="2">
                        <div class="wave-symbol">Œ¥</div>
                        <div class="wave-name">Delta</div>
                        <div class="wave-freq">0.5-4 Hz</div>
                    </div>
                    <div class="wave-card theta active" data-wave="theta" data-freq="6">
                        <div class="wave-symbol">Œ∏</div>
                        <div class="wave-name">Theta</div>
                        <div class="wave-freq">4-8 Hz</div>
                    </div>
                    <div class="wave-card alpha" data-wave="alpha" data-freq="10">
                        <div class="wave-symbol">Œ±</div>
                        <div class="wave-name">Alpha</div>
                        <div class="wave-freq">8-13 Hz</div>
                    </div>
                    <div class="wave-card beta" data-wave="beta" data-freq="18">
                        <div class="wave-symbol">Œ≤</div>
                        <div class="wave-name">Beta</div>
                        <div class="wave-freq">13-30 Hz</div>
                    </div>
                    <div class="wave-card gamma" data-wave="gamma" data-freq="40">
                        <div class="wave-symbol">Œ≥</div>
                        <div class="wave-name">Gamma</div>
                        <div class="wave-freq">30-100 Hz</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">üéß Battements Binauraux</h3>
                <div class="control-group">
                    <label>Fr√©quence de base</label>
                    <div class="slider-row">
                        <input type="range" id="binBase" min="100" max="500" value="200">
                        <span class="value" id="binBaseVal">200 Hz</span>
                    </div>
                </div>
                <div class="control-group">
                    <label>Diff√©rence (Hz)</label>
                    <div class="slider-row">
                        <input type="range" id="binDiff" min="0.5" max="40" value="6" step="0.5">
                        <span class="value" id="binDiffVal">6 Hz</span>
                    </div>
                </div>
                
                <div class="visualizer">
                    <canvas id="brainwaveVis"></canvas>
                </div>
            </div>
        </div>
        
        <!-- EFFECTS PANEL -->
        <div class="panel" id="panelEffects">
            <div class="card">
                <h3 class="card-title">üéõÔ∏è Effets Audio</h3>
                
                <!-- Echo -->
                <div class="effect-row">
                    <div class="effect-info">
                        <span class="effect-icon">üîä</span>
                        <div>
                            <div style="font-weight:600">Echo</div>
                            <div style="font-size:0.8rem;color:var(--text-dim)">R√©p√©tition du signal</div>
                        </div>
                    </div>
                    <div class="toggle" id="echoToggle"></div>
                </div>
                <div class="control-group">
                    <label>Delay (ms)</label>
                    <div class="slider-row">
                        <input type="range" id="echoDelay" min="50" max="1000" value="300">
                        <span class="value" id="echoDelayVal">300ms</span>
                    </div>
                </div>
                <div class="control-group">
                    <label>Feedback</label>
                    <div class="slider-row">
                        <input type="range" id="echoFeedback" min="0" max="90" value="50">
                        <span class="value" id="echoFeedbackVal">50%</span>
                    </div>
                </div>
                
                <!-- Reverb -->
                <div class="effect-row">
                    <div class="effect-info">
                        <span class="effect-icon">üåä</span>
                        <div>
                            <div style="font-weight:600">Reverb</div>
                            <div style="font-size:0.8rem;color:var(--text-dim)">R√©verb√©ration spatiale</div>
                        </div>
                    </div>
                    <div class="toggle" id="reverbToggle"></div>
                </div>
                <div class="control-group">
                    <label>Room Size</label>
                    <div class="slider-row">
                        <input type="range" id="reverbSize" min="0" max="100" value="50">
                        <span class="value" id="reverbSizeVal">50%</span>
                    </div>
                </div>
                
                <!-- Loop -->
                <div class="effect-row">
                    <div class="effect-info">
                        <span class="effect-icon">üîÑ</span>
                        <div>
                            <div style="font-weight:600">Loop</div>
                            <div style="font-size:0.8rem;color:var(--text-dim)">Lecture en boucle</div>
                        </div>
                    </div>
                    <div class="toggle active" id="loopToggle"></div>
                </div>
                <div class="control-group">
                    <label>Bars</label>
                    <div class="slider-row">
                        <input type="range" id="loopBars" min="1" max="16" value="4">
                        <span class="value" id="loopBarsVal">4 bars</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">üîä Volume Master</h3>
                <div class="control-group">
                    <div class="slider-row">
                        <input type="range" id="masterVol" min="0" max="100" value="70">
                        <span class="value" id="masterVolVal">70%</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">üíæ Export</h3>
                <div class="export-grid">
                    <button class="btn btn-primary btn-sm" onclick="exportWAV()">üíæ WAV</button>
                    <button class="btn btn-secondary btn-sm" onclick="exportMP3()">üéµ MP3</button>
                    <button class="btn btn-secondary btn-sm" onclick="exportMIDI()">üéπ MIDI</button>
                </div>
            </div>
        </div>
        
        <!-- TRANSPORT -->
        <div class="transport">
            <button class="transport-btn" onclick="stopAll()">‚èπÔ∏è</button>
            <button class="transport-btn play" id="playBtn" onclick="togglePlay()">‚ñ∂Ô∏è</button>
            <button class="transport-btn" onclick="record()">üî¥</button>
            
            <div class="tempo-control">
                <button class="tempo-btn" onclick="changeTempo(-5)">‚àí</button>
                <div class="tempo-display"><span id="tempoVal">120</span> BPM</div>
                <button class="tempo-btn" onclick="changeTempo(5)">+</button>
            </div>
            
            <div class="time-display" id="timeDisplay">00:00</div>
        </div>
    </main>

    <script>
        // ============================================
        // AUDIO ENGINE
        // ============================================
        
        let audioContext = null;
        let masterGain = null;
        let analyser = null;
        let isPlaying = false;
        let startTime = 0;
        let tempo = 120;
        let currentOctave = 4;
        let noteDuration = 0.5;
        
        const activeOscillators = new Map();
        
        const NOTE_FREQS = {
            'C': [32.70, 65.41, 130.81, 261.63, 523.25, 1046.50, 2093.00],
            'D': [36.71, 73.42, 146.83, 293.66, 587.33, 1174.66, 2349.32],
            'E': [41.20, 82.41, 164.81, 329.63, 659.26, 1318.51, 2637.02],
            'F': [43.65, 87.31, 174.61, 349.23, 698.46, 1396.91, 2793.83],
            'G': [49.00, 98.00, 196.00, 392.00, 783.99, 1567.98, 3135.96],
            'A': [55.00, 110.00, 220.00, 440.00, 880.00, 1760.00, 3520.00],
            'B': [61.74, 123.47, 246.94, 493.88, 987.77, 1975.53, 3951.07]
        };
        
        const state = {
            brainwave: { type: 'theta', freq: 6, baseFreq: 200 },
            effects: {
                echo: { enabled: false, delay: 0.3, feedback: 0.5 },
                reverb: { enabled: false, size: 0.5 },
                loop: { enabled: true, bars: 4 }
            },
            sequencer: []
        };
        
        function initAudio() {
            if (audioContext) return;
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioContext.createGain();
            masterGain.gain.value = 0.7;
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            masterGain.connect(analyser);
            analyser.connect(audioContext.destination);
        }
        
        function playNote(note, octave = currentOctave, duration = noteDuration) {
            initAudio();
            
            const freq = NOTE_FREQS[note][octave];
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            osc.type = 'sine';
            osc.frequency.value = freq;
            
            const now = audioContext.currentTime;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.8, now + 0.02);
            gain.gain.linearRampToValueAtTime(0.5, now + 0.1);
            gain.gain.setValueAtTime(0.5, now + duration - 0.1);
            gain.gain.linearRampToValueAtTime(0, now + duration);
            
            osc.connect(gain);
            gain.connect(masterGain);
            
            osc.start(now);
            osc.stop(now + duration);
            
            return osc;
        }
        
        function playBinaural() {
            initAudio();
            
            stopOsc('binL');
            stopOsc('binR');
            
            const baseFreq = state.brainwave.baseFreq;
            const diff = state.brainwave.freq;
            
            // Left
            const oscL = audioContext.createOscillator();
            const gainL = audioContext.createGain();
            const panL = audioContext.createStereoPanner();
            oscL.frequency.value = baseFreq;
            gainL.gain.value = 0.4;
            panL.pan.value = -1;
            oscL.connect(gainL);
            gainL.connect(panL);
            panL.connect(masterGain);
            oscL.start();
            activeOscillators.set('binL', { osc: oscL, gain: gainL });
            
            // Right
            const oscR = audioContext.createOscillator();
            const gainR = audioContext.createGain();
            const panR = audioContext.createStereoPanner();
            oscR.frequency.value = baseFreq + diff;
            gainR.gain.value = 0.4;
            panR.pan.value = 1;
            oscR.connect(gainR);
            gainR.connect(panR);
            panR.connect(masterGain);
            oscR.start();
            activeOscillators.set('binR', { osc: oscR, gain: gainR });
        }
        
        function stopOsc(id) {
            if (activeOscillators.has(id)) {
                const { osc, gain } = activeOscillators.get(id);
                gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);
                setTimeout(() => { try { osc.stop(); } catch(e) {} }, 150);
                activeOscillators.delete(id);
            }
        }
        
        function stopAll() {
            activeOscillators.forEach((_, id) => stopOsc(id));
            isPlaying = false;
            updatePlayBtn();
        }
        
        function togglePlay() {
            if (isPlaying) {
                stopAll();
            } else {
                isPlaying = true;
                startTime = audioContext ? audioContext.currentTime : 0;
                
                const panel = document.querySelector('.panel.active').id;
                if (panel === 'panelBrainwaves') {
                    playBinaural();
                }
                
                updatePlayBtn();
                startVisualizerLoop();
            }
        }
        
        function updatePlayBtn() {
            const btn = document.getElementById('playBtn');
            btn.textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
            btn.classList.toggle('playing', isPlaying);
        }
        
        function changeTempo(delta) {
            tempo = Math.max(40, Math.min(240, tempo + delta));
            document.getElementById('tempoVal').textContent = tempo;
        }
        
        function record() { alert('Recording... (√Ä impl√©menter)'); }
        function exportWAV() { alert('Export WAV (√Ä impl√©menter)'); }
        function exportMP3() { alert('Export MP3 (√Ä impl√©menter)'); }
        function exportMIDI() { alert('Export MIDI (√Ä impl√©menter)'); }
        
        // ============================================
        // VISUALIZERS
        // ============================================
        
        function startVisualizerLoop() {
            if (!analyser) return;
            
            const canvas = document.getElementById('pianoVisualizer') || document.getElementById('brainwaveVis');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth * 2;
            const height = canvas.height = canvas.offsetHeight * 2;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            function draw() {
                if (!isPlaying) return;
                requestAnimationFrame(draw);
                
                analyser.getByteTimeDomainData(dataArray);
                
                ctx.fillStyle = 'rgba(10, 10, 15, 0.2)';
                ctx.fillRect(0, 0, width, height);
                
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#00d4aa';
                ctx.beginPath();
                
                const sliceWidth = width / bufferLength;
                let x = 0;
                
                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * height / 2;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                    x += sliceWidth;
                }
                
                ctx.stroke();
            }
            
            draw();
        }
        
        // ============================================
        // SEQUENCER
        // ============================================
        
        function initSequencer() {
            const grid = document.getElementById('sequencerGrid');
            grid.innerHTML = '';
            
            const notes = ['B', 'A', 'G', 'F', 'E', 'D', 'C'];
            const steps = 16;
            
            notes.forEach(note => {
                const row = document.createElement('div');
                row.className = 'seq-row';
                row.dataset.note = note;
                
                const label = document.createElement('div');
                label.className = 'seq-label';
                label.textContent = note;
                row.appendChild(label);
                
                for (let i = 0; i < steps; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'seq-cell';
                    cell.dataset.step = i;
                    cell.onclick = () => cell.classList.toggle('active');
                    row.appendChild(cell);
                }
                
                grid.appendChild(row);
            });
        }
        
        // ============================================
        // INIT
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    const panelId = 'panel' + tab.dataset.panel.charAt(0).toUpperCase() + tab.dataset.panel.slice(1);
                    document.getElementById(panelId).classList.add('active');
                };
            });
            
            // Piano keys
            document.querySelectorAll('.piano-key-colored').forEach(key => {
                const play = () => {
                    initAudio();
                    playNote(key.dataset.note, currentOctave, noteDuration);
                    key.classList.add('playing');
                    setTimeout(() => key.classList.remove('playing'), noteDuration * 1000);
                };
                key.onmousedown = play;
                key.ontouchstart = (e) => { e.preventDefault(); play(); };
            });
            
            // Octave selector
            document.querySelectorAll('.octave-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.octave-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentOctave = parseInt(btn.dataset.octave);
                    updatePianoFreqs();
                };
            });
            
            // Duration buttons
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    noteDuration = parseFloat(btn.dataset.dur);
                };
            });
            
            // Brainwave cards
            document.querySelectorAll('.wave-card').forEach(card => {
                card.onclick = () => {
                    document.querySelectorAll('.wave-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    state.brainwave.type = card.dataset.wave;
                    state.brainwave.freq = parseFloat(card.dataset.freq);
                    document.getElementById('binDiff').value = state.brainwave.freq;
                    document.getElementById('binDiffVal').textContent = state.brainwave.freq + ' Hz';
                    if (isPlaying) playBinaural();
                };
            });
            
            // Effect toggles
            document.querySelectorAll('.toggle').forEach(toggle => {
                toggle.onclick = () => toggle.classList.toggle('active');
            });
            
            // Sliders
            const sliders = [
                { id: 'binBase', val: 'binBaseVal', suffix: ' Hz', action: v => state.brainwave.baseFreq = v },
                { id: 'binDiff', val: 'binDiffVal', suffix: ' Hz', action: v => state.brainwave.freq = v },
                { id: 'echoDelay', val: 'echoDelayVal', suffix: 'ms' },
                { id: 'echoFeedback', val: 'echoFeedbackVal', suffix: '%' },
                { id: 'reverbSize', val: 'reverbSizeVal', suffix: '%' },
                { id: 'loopBars', val: 'loopBarsVal', suffix: ' bars' },
                { id: 'masterVol', val: 'masterVolVal', suffix: '%', action: v => masterGain && (masterGain.gain.value = v/100) },
                { id: 'seqSteps', val: 'seqStepsVal', suffix: '' }
            ];
            
            sliders.forEach(s => {
                const el = document.getElementById(s.id);
                if (el) {
                    el.oninput = () => {
                        document.getElementById(s.val).textContent = el.value + s.suffix;
                        if (s.action) s.action(parseFloat(el.value));
                    };
                }
            });
            
            // Init sequencer
            initSequencer();
            
            // Time display
            setInterval(() => {
                if (isPlaying && audioContext) {
                    const elapsed = audioContext.currentTime - startTime;
                    const mins = Math.floor(elapsed / 60);
                    const secs = Math.floor(elapsed % 60);
                    document.getElementById('timeDisplay').textContent = 
                        `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
            }, 200);
            
            // Keyboard
            document.addEventListener('keydown', e => {
                if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
            });
        });
        
        function updatePianoFreqs() {
            const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            document.querySelectorAll('.piano-key-colored').forEach((key, i) => {
                const freq = NOTE_FREQS[notes[i]][currentOctave];
                key.dataset.freq = freq;
                key.querySelector('.key-freq').textContent = freq.toFixed(2);
            });
        }
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(e => console.log('SW:', e));
        }
    </script>
</body>
</html>
